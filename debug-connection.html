<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€£æ¥è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Google Apps Script é€£æ¥è¨ºæ–·å·¥å…·</h1>
    
    <div class="info-box">
        <strong>ç›®å‰è¨­å®šçš„ URLï¼š</strong><br>
        <code id="currentUrl">è¼‰å…¥ä¸­...</code>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ æª¢æŸ¥æ¸…å–®</h2>
        <div id="checklist">
            <div>âœ… ç¢ºèªæ‚¨å·²ç¶“å°‡ Code.gs è¤‡è£½åˆ° Google Apps Script</div>
            <div>âœ… ç¢ºèªæ‚¨å·²ç¶“å•Ÿç”¨ä»¥ä¸‹ API æœå‹™ï¼šGoogle Sheets API, Gmail API, Google Calendar API</div>
            <div>âœ… ç¢ºèªæ‚¨å·²ç¶“å°‡ Apps Script éƒ¨ç½²ç‚ºã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</div>
            <div>âœ… ç¢ºèªæ¬Šé™è¨­å®šç‚ºã€Œä»»ä½•äººã€å¯ä»¥å­˜å–</div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸŒ åŸºæœ¬é€£æ¥æ¸¬è©¦</h2>
        <button onclick="testBasicConnection()">æ¸¬è©¦åŸºæœ¬é€£æ¥</button>
        <div id="basicResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ” Token é©—è­‰æ¸¬è©¦</h2>
        <button onclick="testTokenValidation()">æ¸¬è©¦ Token</button>
        <div id="tokenResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ è¡¨å–®æäº¤æ¸¬è©¦</h2>
        <button onclick="testFormSubmission()">æ¸¬è©¦è¡¨å–®æäº¤</button>
        <div id="formResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š çµ±è¨ˆè³‡æ–™æ¸¬è©¦</h2>
        <button onclick="testStatsRetrieval()">æ¸¬è©¦çµ±è¨ˆè³‡æ–™</button>
        <div id="statsResult"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ› ï¸ ä¿®å¾©å»ºè­°</h2>
        <div id="suggestions"></div>
    </div>

    <script>
        // å¾ä¸»é é¢è¤‡è£½çš„ URL
        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0wuk7Rl8iVd6ox54mFERkPJGSazPeoM32sZx4X2ybOlHd0eG8cwvaMoBsR2o2Tn8/exec?token=rsvp_secret_2025_aB9kL3mN7qR4tW8xY2zA5fH6jK9nP3sV1xC7eG2mQ8vR4tY7zB9kL3nP6sW1xY4zA7fH9jK2mQ5tR8vB1xC4eG7j";

        // é¡¯ç¤ºç›®å‰çš„ URL
        document.getElementById('currentUrl').textContent = WEBAPP_URL;

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showSuggestion(message) {
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML += `<div class="warning">${message}</div>`;
        }

        async function testBasicConnection() {
            showResult('basicResult', 'æ­£åœ¨æ¸¬è©¦åŸºæœ¬é€£æ¥...', 'loading');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ™‚
                
                const response = await fetch(WEBAPP_URL, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const text = await response.text();
                    showResult('basicResult', `âœ… åŸºæœ¬é€£æ¥æˆåŠŸï¼ç‹€æ…‹ç¢¼: ${response.status}<br>å›æ‡‰: ${text.substring(0, 200)}...`, 'success');
                } else {
                    showResult('basicResult', `âŒ é€£æ¥å¤±æ•—ï¼ç‹€æ…‹ç¢¼: ${response.status}<br>ç‹€æ…‹æ–‡å­—: ${response.statusText}`, 'error');
                    showSuggestion('è«‹æª¢æŸ¥ Apps Script æ˜¯å¦æ­£ç¢ºéƒ¨ç½²ç‚ºç¶²é æ‡‰ç”¨ç¨‹å¼ï¼Œä¸¦ä¸”æ¬Šé™è¨­å®šç‚ºã€Œä»»ä½•äººã€å¯å­˜å–ã€‚');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showResult('basicResult', 'âŒ é€£æ¥è¶…æ™‚ï¼ˆè¶…é10ç§’ï¼‰', 'error');
                    showSuggestion('é€£æ¥è¶…æ™‚é€šå¸¸è¡¨ç¤º URL ä¸æ­£ç¢ºæˆ– Apps Script æœå‹™ç„¡å›æ‡‰ã€‚è«‹æª¢æŸ¥éƒ¨ç½² URLã€‚');
                } else {
                    showResult('basicResult', `âŒ é€£æ¥éŒ¯èª¤: ${error.message}`, 'error');
                    if (error.message.includes('Failed to fetch')) {
                        showSuggestion('ã€ŒFailed to fetchã€éŒ¯èª¤é€šå¸¸è¡¨ç¤ºï¼š<br>1. CORS å•é¡Œ<br>2. ç¶²è·¯é€£æ¥å•é¡Œ<br>3. Apps Script æœªæ­£ç¢ºéƒ¨ç½²<br>4. URL ä¸æ­£ç¢º');
                    }
                }
            }
        }

        async function testTokenValidation() {
            showResult('tokenResult', 'æ­£åœ¨æ¸¬è©¦ Token é©—è­‰...', 'loading');
            
            try {
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        test: true,
                        name: 'Test User'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.error && result.error.includes('token')) {
                        showResult('tokenResult', `âŒ Token é©—è­‰å¤±æ•—: ${result.error}`, 'error');
                        showSuggestion('Token ä¸åŒ¹é…ï¼è«‹ç¢ºèª Code.gs ä¸­çš„ SECRET_TOKEN èˆ‡ URL ä¸­çš„ token åƒæ•¸ä¸€è‡´ã€‚');
                    } else {
                        showResult('tokenResult', 'âœ… Token é©—è­‰é€šéï¼', 'success');
                    }
                } else {
                    showResult('tokenResult', `âŒ HTTP éŒ¯èª¤: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('tokenResult', `âŒ Token æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testFormSubmission() {
            showResult('formResult', 'æ­£åœ¨æ¸¬è©¦è¡¨å–®æäº¤...', 'loading');
            
            const testData = {
                name: 'æ¸¬è©¦ç”¨æˆ¶',
                email: 'test@example.com',
                attend: 'yes',
                num_people: 1,
                note: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦æäº¤'
            };

            try {
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showResult('formResult', `âœ… è¡¨å–®æäº¤æˆåŠŸï¼<br>å›æ‡‰: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    const text = await response.text();
                    showResult('formResult', `âŒ è¡¨å–®æäº¤å¤±æ•—: ${response.status}<br>å›æ‡‰: ${text}`, 'error');
                }
            } catch (error) {
                showResult('formResult', `âŒ è¡¨å–®æäº¤éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testStatsRetrieval() {
            showResult('statsResult', 'æ­£åœ¨æ¸¬è©¦çµ±è¨ˆè³‡æ–™æª¢ç´¢...', 'loading');
            
            try {
                const statsUrl = WEBAPP_URL.replace('?token=', '?action=list&token=');
                const response = await fetch(statsUrl);

                if (response.ok) {
                    const result = await response.json();
                    showResult('statsResult', `âœ… çµ±è¨ˆè³‡æ–™æª¢ç´¢æˆåŠŸï¼<br>è³‡æ–™ç­†æ•¸: ${Array.isArray(result) ? result.length : 'æœªçŸ¥'}`, 'success');
                } else {
                    showResult('statsResult', `âŒ çµ±è¨ˆè³‡æ–™æª¢ç´¢å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('statsResult', `âŒ çµ±è¨ˆè³‡æ–™æª¢ç´¢éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•é¡¯ç¤ºä¸€äº›åŸºæœ¬è³‡è¨Š
        window.addEventListener('DOMContentLoaded', function() {
            // æª¢æŸ¥ URL æ ¼å¼
            if (!WEBAPP_URL.includes('script.google.com/macros/s/') || !WEBAPP_URL.includes('/exec')) {
                showSuggestion('âš ï¸ URL æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚æ­£ç¢ºçš„ Apps Script Web App URL æ‡‰è©²é¡ä¼¼æ–¼ï¼š<br><code>https://script.google.com/macros/s/[DEPLOY_ID]/exec?token=[TOKEN]</code>');
            }
            
            // æª¢æŸ¥ Token é•·åº¦
            const urlParams = new URLSearchParams(WEBAPP_URL.split('?')[1]);
            const token = urlParams.get('token');
            if (!token || token.length < 20) {
                showSuggestion('âš ï¸ Token çœ‹èµ·ä¾†å¤ªçŸ­æˆ–ä¸å­˜åœ¨ã€‚å»ºè­°ä½¿ç”¨è‡³å°‘20å­—ç¬¦çš„éš¨æ©Ÿå­—ä¸²ä½œç‚ºå®‰å…¨ tokenã€‚');
            }
        });
    </script>
</body>
</html>